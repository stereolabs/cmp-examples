# GPS Tracker

This sample is an example that shows you how to send GPS data in a ZED Hub App to display them in the [Map page](https://cloud.stereolabs.com/maps). It also shows how to use it to generate:

- **Logs** that informs you about the app's status
- **Telemetry** that stores data linked to the detections

The app defines **parameters** that can be modified in the ZED Hub interface and to change the app's behaviour while its running.

## Requirements

This sample is a mix of the **basic tutorials** provided in the `tutorials` folder. We recommend to **read and test them** before running this sample. These tutorials provide a lot of information on the ZED Hub features and will make it easier to understand the **GPS Tracker Sample**.

You will deploy this tutorial on one of the devices installed on your ZED Hub workspace. ZED Hub supports Jetson Nano, TX2, Xavier and Orin, or any computer. If you are using a Jetson, make sure it has been flashed. If you haven't done it already, [flash your Jetson](https://docs.nvidia.com/sdk-manager/install-with-sdkm-jetson/index.html).

To be able to run this tutorial:

- [Sign In the ZED Hub and create a workspace](https://www.stereolabs.com/docs/cloud/overview/get-started/).
- [Add and Setup a device](https://www.stereolabs.com/docs/cloud/overview/get-started/#add-a-camera).
- A ZED must be plugged to this device.
- **Enable recordings** and **disable privacy mode** in the Settings panel of your device.

## Build and deploy this tutorial

### How to build your application (for development)

Run the Edge Agent installed on your device using :

```
$ edge_cli start
```

Then to build your app :

```
$ cd sources
$ mkdir build
$ cd build
$ cmake ..
$ make -j$(nproc)
```

This application defines application parameters in order to modify its behavior while it is running. Move the `parameters.json` file to the path you specified in the `HubClient::loadApplicationParameters` function.

```
$ cp ../parameters.json .
```

Then to run your app :

```
./GPS_Tracker_Sample
```

To dynamically change the parameters and activate their callbacks, edit the `parameters.json` file.

### How to build your application (for service deployment)

To build your app just run:

```
$ cd /PATH/TO/gps_tracker_sample
$ edge_cli build
```

This command is available by installing Edge Agent on your device.

- The command will ask for the **device type** (Jetson or x86) on which you want to deploy this app.
- The command will also ask for your **device cuda version**. If you do not know it you can find it in the **Info** section of your device in the ZED Hub interface.
- Finally you will be asked the **sl_iot version** you want to use. The default one is the one installed on your device with Edge Agent. It corresponds to the base docker image used to build your app docker image. You can chose the default one, or look for the [most recent version available on Dockerhub](https://hub.docker.com/r/stereolabs/iot/tags?page=1&ordering=last_updated).

### How to deploy your application

Packages your app by generating a app.zip file using :

```
$ edge_cli build
```

You can now [deploy your app](https://www.stereolabs.com/docs/cloud/applications/sample/#deploy) using the ZED Hub interface:

- In your workspace, in the **Applications** section, click on **Create a new app**
- Select the ZIP file containing the application in your filesystem
- Select the devices on which you want to deploy the app and press **Deploy**

## What you should see after deployment

### Live video

A video with bounding boxes around detected persons should be available in the **Video** panel.

### Logs

The logs should inform you about the app status.

### Telemetry

The telemetries containing GPS data should be available and generated every second by default.

### Maps

The GPS data should be display on a map.

### Parameters

One parameter can be used to modify your app behaviour:

- **Telemetry frequency**: Telemetry frequency defines how often telemetry is generated by the app. Every second by default.

## Code overview

### Parameters callback

Some callbacks are defined and will be called when a parameter will be modified through the interface. The are used to modify the parameter value and notify that the change has been done.

Callback for `telemetry_freq` parameter

```c++
void onTelemetryUpdate(FunctionEvent &event)
{
    event.status = 0;
    telemetryFreq = HubClient::getParameter<float>("telemetryFreq", PARAMETER_TYPE::APPLICATION, telemetryFreq);
    HubClient::sendLog("New parameters : telemetryFreq modified", LOG_LEVEL::INFO);
}
```

### Initialisation

As usual, the app is init with `HubClient::connect` and `HubClient::registerCamera` and the ZED is started with the ZED SDK `open` function.

### Main loop

- **Telemetries** relative to the detected objects are defined and sent. See `tutorial_03_telemetries`.

```c++
Timestamp current_ts = p_zed->getTimestamp(TIME_REFERENCE::IMAGE);

if ((uint64_t)(current_ts.getMilliseconds() >= (uint64_t)(prev_timestamp.getMilliseconds() + (uint64_t)telemetryFreq * 1000ULL)))
{
    // Update coordinate
    latitude += getRandom();
    latitude = min(90.0, latitude);
    latitude = max(-90.0, latitude);
    longitude += getRandom();
    longitude = min(180.0, longitude);
    longitude = max(-180.0, longitude);
    altitude += getRandom();

    // Send Telemetry
    json gps;
    gps["layer_type"] = "geolocation";
    gps["position"] = {
        {"latitude", latitude},
        {"longitude", longitude},
        {"altitude", altitude}
    };
    gps["position"]["uncertainty"] = {
        {"eph", NULL},
        {"epv", NULL},
    };
    gps["velocity"] = {
        {"x", NULL},
        {"y", NULL},
        {"z", NULL}
    };
    gps["rotation"] = {
        {"x", NULL },
        {"y", NULL},
        {"z", NULL}
    };
    gps["epoch_timestamp"] = current_ts.getMilliseconds();
    HubClient::sendTelemetry("GPS_data", gps);
    prev_timestamp = current_ts;
}
```
